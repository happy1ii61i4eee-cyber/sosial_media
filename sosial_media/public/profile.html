<h1>æœƒå“¡ä¸­å¿ƒ</h1>

<div id="userInfo"></div>

<hr>

<!-- ğŸ“ æ–°å¢è²¼æ–‡ -->
<h2>ç™¼è¡¨æ–°è²¼æ–‡</h2>
<textarea id="newPostContent" rows="3" cols="50" placeholder="è¼¸å…¥è²¼æ–‡å…§å®¹..."></textarea><br>
<button id="postBtn">ç™¼ä½ˆè²¼æ–‡</button>

<hr>

<!-- ğŸ’¬ æŸ¥è©¢è²¼æ–‡ -->
<h2>æœå°‹è²¼æ–‡</h2>
<input type="text" id="searchUsername" placeholder="è¼¸å…¥æœƒå“¡å¸³è™Ÿ">
<button id="searchBtn">æœå°‹</button>

<hr>

<!-- ğŸ§¾ é¡¯ç¤ºè²¼æ–‡èˆ‡ç•™è¨€ -->
<h2>è²¼æ–‡èˆ‡ç•™è¨€</h2>
<div id="postsContainer"></div>
<button onclick="loadProfile()">ğŸ”„ é‡æ–°æ•´ç†</button>
<button onclick="logout()">ğŸšª ç™»å‡º</button>

<script>
const token = localStorage.getItem('token');
function logout() {
  localStorage.removeItem('token');
  window.location.href = '/login.html';
}

// ğŸ§­ è¼‰å…¥æœƒå“¡è³‡æ–™
async function loadProfile() {
  const res = await fetch('/members/profile', {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  const data = await res.json();

  if (!res.ok) {
    alert('ç™»å…¥é€¾æ™‚æˆ–æ¬Šé™å¤±æ•ˆï¼Œè«‹é‡æ–°ç™»å…¥');
    window.location.href = '/login.html';
    return;
  }

  const userInfo = document.getElementById('userInfo');
  userInfo.innerHTML = `<p>æ­¡è¿, ${data.user.username}</p>
                        <p>ID: ${data.user.id} ï½œ åŸå¸‚: ${data.user.city || 'æœªå¡«å¯«'}</p>`;
  renderPosts(data.posts, data.comments);
}

// ğŸ“ æ–°å¢è²¼æ–‡
document.getElementById('postBtn').addEventListener('click', async () => {
  const content = document.getElementById('newPostContent').value.trim();
  if (!content) return alert('è«‹è¼¸å…¥å…§å®¹');

  const res = await fetch('/members/post', {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token
    },
    body: JSON.stringify({ content })
  });

  const data = await res.json();
  if (res.ok) {
    alert('è²¼æ–‡æˆåŠŸï¼');
    document.getElementById('newPostContent').value = '';
    loadProfile(); // é‡æ–°è¼‰å…¥è²¼æ–‡
  } else {
    alert(data.error || 'è²¼æ–‡å¤±æ•—');
  }
});

// ğŸ’¬ æœå°‹è²¼æ–‡
document.getElementById('searchBtn').addEventListener('click', async () => {
  const username = document.getElementById('searchUsername').value.trim();
  if (!username) return alert('è«‹è¼¸å…¥æœƒå“¡åç¨±');

  const res = await fetch(`/members/searchPost?username=${username}`, {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  const data = await res.json();

  if (res.ok) {
    renderPosts(data.posts, data.comments);
  } else {
    alert(data.error || 'æŸ¥è©¢å¤±æ•—');
  }
});

// ğŸ’¬ é¡¯ç¤ºè²¼æ–‡ï¼‹ç•™è¨€
function renderPosts(posts, comments) {
  const container = document.getElementById('postsContainer');
  container.innerHTML = '';

  posts.forEach(post => {
    const postComments = comments.filter(c => c.post_id === post.id);
    const commentHtml = postComments.map(c => `
      <p>ç•™è¨€è€…: ${c.username}</p>
      <p>${c.content}</p>
    `).join('<hr>');

    const postEl = document.createElement('div');
    postEl.innerHTML = `
      <p><strong>${post.username}</strong>ï¼š${post.content}</p>
      <p>æ™‚é–“ï¼š${new Date(post.created_at).toLocaleString()}</p>
      <div>${commentHtml || '<p>å°šç„¡ç•™è¨€</p>'}</div>
      <textarea rows="2" placeholder="ç•™è¨€..." id="comment-${post.id}"></textarea>
      <button onclick="addComment(${post.id})">é€å‡ºç•™è¨€</button>
      <hr>
    `;
    container.appendChild(postEl);
  });
}

// ğŸ’¬ æ–°å¢ç•™è¨€
async function addComment(postID) {
  const comment = document.getElementById(`comment-${postID}`).value.trim();
  if (!comment) return alert('è«‹è¼¸å…¥ç•™è¨€å…§å®¹');

  const res = await fetch('/members/post', {
    method: 'PUT',
    headers: { 
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token
    },
    body: JSON.stringify({ postID, comment })
  });

  const data = await res.json();
  if (res.ok) {
    alert('ç•™è¨€æˆåŠŸï¼');
    loadProfile();
  } else {
    alert(data.error || 'ç•™è¨€å¤±æ•—');
  }
}





loadProfile();
</script>